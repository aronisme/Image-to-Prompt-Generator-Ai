<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="manifest" href="manifest.json">
  <title>PromptLab — Image ➜ Prompt (Lite)</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg:#0b1220;/* dark base */
      --card:#0f172a;--ink:#e5e7eb;--ink2:#cbd5e1;--muted:#94a3b8;
      --brand:#0ea5e9;--brand-2:#0284c7;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
      --line:#1f2a44
    }
    @media (prefers-color-scheme: light){:root{--bg:#f6f8fb;--card:#ffffff;--ink:#1f2937;--ink2:#374151;--muted:#6b7280;--brand:#0ea5e9;--brand-2:#0284c7;--ok:#16a34a;--warn:#ca8a04;--err:#dc2626;--line:#e5e7eb}}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 80% -10%,rgba(14,165,233,.15),transparent),var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--ok));box-shadow:0 6px 24px rgba(14,165,233,.25)}
    h1{font-size:18px;margin:0}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}

    .grid{display:grid;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:360px 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{font-size:14px;margin:0 0 8px;color:var(--ink2)}

    label{display:block;margin:10px 0 6px;color:var(--ink2);font-weight:600;font-size:13px}
    input,select,textarea,button{width:100%;border:1px solid var(--line);background:#0000;color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    textarea{min-height:90px;resize:vertical}
    button{cursor:pointer;background:var(--brand);border-color:transparent;font-weight:700}
    button.secondary{background:#0000;border-color:var(--line)}
    button.ghost{background:#0000;border-color:transparent;color:var(--muted)}
    button.danger{background:var(--err)}

    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .drop{display:grid;place-items:center;border:2px dashed var(--line);border-radius:14px;padding:18px;text-align:center;color:var(--muted)}
    .drop.drag{border-color:var(--brand)}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;max-height:160px;overflow:auto}
    .thumb{width:110px;height:80px;object-fit:cover;border:1px solid var(--line);border-radius:8px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .result{display:grid;gap:10px;max-height:460px;overflow:auto}
    .item{display:grid;gap:8px;border:1px solid var(--line);background:linear-gradient(0deg,rgba(255,255,255,.02),transparent);border-radius:12px;padding:10px}
    .item .meta{display:flex;justify-content:space-between;gap:8px;color:var(--muted);font-size:12px}

    .progress{height:10px;background:#0000;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--ok))}

    .toast{position:fixed;right:14px;bottom:14px;display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:var(--card);border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.25);color:var(--ink);opacity:0;transform:translateY(10px);transition:all .2s}
    .toast.show{opacity:1;transform:translateY(0)}

    .muted{color:var(--muted)}
    footer{margin:16px 0;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><div class="logo" aria-hidden="true"></div><h1>PromptLab</h1><span class="pill">Lite v2</span></div>
      <div class="toolbar">
        <button id="btnKeys" class="secondary" title="Manage API Keys">API Keys</button>
        <button id="btnLogout" class="ghost" title="Logout">Logout</button>
      </div>
    </header>

    <div id="authGate" class="card" hidden>
      <h2>Checking access…</h2>
      <div class="progress" aria-label="Auth progress"><div class="bar" id="authBar"></div></div>
      <p class="muted" id="authMsg">Connecting to server…</p>
    </div>

    <section class="grid" id="app" hidden>
      <!-- Left: Controls -->
      <div class="card">
        <h2>Settings</h2>
        <div class="row">
          <div>
            <label for="numPrompts">Prompts per Image</label>
            <input id="numPrompts" type="number" min="1" max="10" value="2" />
          </div>
          <div>
            <label for="variation">Variation Level</label>
            <select id="variation">
              <option value="low">Low (slight)</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="styleFocus">Style Focus</label>
            <select id="styleFocus">
              <option value="auto">Auto (follow image)</option>
              <option value="realistic">Realistic</option>
              <option value="abstract">Abstract</option>
              <option value="cartoon">Cartoon</option>
              <option value="minimalist">Minimalist</option>
            </select>
          </div>
          <div>
            <label for="platform">Target Platform</label>
            <select id="platform">
              <option value="adobe_stock">Adobe Stock</option>
              <option value="shutterstock">Shutterstock</option>
              <option value="general">General</option>
            </select>
          </div>
        </div>

        <label for="file">Images</label>
        <div id="drop" class="drop" tabindex="0" aria-label="Drop zone">
          <div>
            <p class="muted">Drag & drop / click to select / paste (Ctrl+V)</p>
            <input id="file" type="file" accept="image/*" multiple hidden />
            <button id="btnPick" class="secondary">Choose Images</button>
          </div>
        </div>
        <div id="thumbs" class="thumbs" aria-live="polite"></div>

        <div class="row" style="margin-top:10px">
          <button id="btnRun">Generate</button>
          <button id="btnCancel" class="danger">Cancel</button>
        </div>

        <div style="margin-top:10px">
          <div class="progress" aria-label="Overall progress"><div class="bar" id="overallBar"></div></div>
          <p class="muted" id="status">Idle</p>
        </div>
      </div>

      <!-- Right: Output -->
      <div class="card">
        <h2>Output</h2>
        <div class="toolbar" style="margin-bottom:10px">
          <button id="btnCopyAll" class="secondary">Copy All</button>
          <button id="btnSaveTxt" class="secondary">Save .txt</button>
          <button id="btnSaveJson" class="secondary">Save .json</button>
        </div>
        <div id="result" class="result" aria-live="polite"></div>
      </div>
    </section>

    <footer>© PromptLab — client‑side only. Keep content stock‑safe. No trademarked logos.
      <span class="muted">Model: gemini‑1.5‑flash</span>
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"><span id="toastMsg">Ready</span></div>

  <script>
    // ===== Constants (kept from v1) =====
    const API_VALIDATE = "/.netlify/functions/validate"; // auth check
    const GEMINI_MODEL = "gemini-1.5-flash";              // model
    const MAX_FILE_SIZE = 10 * 1024 * 1024;               // 10MB
    const CONCURRENCY = 3;                                 // workers

    // ===== State =====
    let aborter = null;

    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    const showToast=(m)=>{const t=$('#toast');$('#toastMsg').textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1600)}
    const toBase64 = file => new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.onerror=rej;r.readAsDataURL(file)})

    function saveKeys(str){localStorage.setItem('apiKeys',str)}
    function loadKeys(){return (localStorage.getItem('apiKeys')||'').split('\n').map(s=>s.trim()).filter(Boolean)}

    function sanitizePlainText(s){
      return s.split('\n').map(l=>l.trim()).filter(l=>l && !/^[\[\]{}]$/.test(l))
    }

    function normalizeJsonText(txt){
      return txt.replace(/```json|```/g,'').trim()
    }

    function parsePrompts(rawText){
      try{
        const j = JSON.parse(normalizeJsonText(rawText));
        if(Array.isArray(j)) return j.filter(x=>typeof x==='string' && x.trim())
        if(j && Array.isArray(j.prompts)){
          return j.prompts.map(it=> typeof it==='string'? it : (it?.prompt || it?.prompt_text || '') ).filter(Boolean)
        }
        // Unknown JSON shape ➜ fallback
        return sanitizePlainText(rawText)
      }catch(e){
        return sanitizePlainText(rawText)
      }
    }

    function download(name, text){
      const blob=new Blob([text],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=el('a',{href:url,download:name});document.body.appendChild(a);a.click();URL.revokeObjectURL(url);a.remove()
    }

    function fileMeta(file){
      return { name:file.name, size:file.size, type:file.type }
    }

    // ===== Auth Gate =====
    async function checkAuth(){
      const gate=$('#authGate'),bar=$('#authBar'),msg=$('#authMsg');
      gate.hidden=false; bar.style.width='15%'; msg.textContent='Locating token…';
      const token=localStorage.getItem('auth_token');
      if(!token){location.href='login.html';return}
      try{
        bar.style.width='40%'; msg.textContent='Validating…';
        const res = await fetch(API_VALIDATE,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token})});
        const j = await res.json().catch(()=>({}));
        bar.style.width='80%'
        if(res.ok && j.ok){
          msg.textContent='Granted'; bar.style.width='100%'; await sleep(250);
          gate.hidden=true; $('#app').hidden=false; showToast('Welcome back 👑')
        }else{ localStorage.removeItem('auth_token'); location.href='login.html' }
      }catch(err){ localStorage.removeItem('auth_token'); location.href='login.html' }
    }

    // ===== Gemini Caller (with retries/round‑robin keys) =====
    async function callGemini({b64, prompt, mime}){
      const keys = loadKeys();
      if(!keys.length) throw new Error('No API keys. Open “API Keys”.');
      let keyIdx=0; const MAX_RETRY=3;
      while(keyIdx<keys.length){
        for(let attempt=1; attempt<=MAX_RETRY; attempt++){
          try{
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${keys[keyIdx]}` ,{
              method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
                contents:[{parts:[{text:prompt},{inlineData:{mimeType:mime,data:b64}}]}]
              })
            });
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          }catch(e){ if(attempt===MAX_RETRY) keyIdx++; await sleep(300*attempt) }
        }
      }
      throw new Error('All API keys exhausted');
    }

    // ===== Worker =====
    async function* processFiles(files,{numPrompts,styleFocus,platform,variation}){
      for(const file of files){
        if(!file.type.startsWith('image/')){yield {file,error:'Not an image'}; continue}
        if(file.size>MAX_FILE_SIZE){yield {file,error:'File > 10MB'}; continue}
        const b64 = await toBase64(file);
        const styleText = styleFocus==='auto'? 'based on the image style' : `in ${styleFocus} style`;
        const platformText = platform==='general' ? 'general use' : `optimized for ${platform}`;
        const variationRule = variation==='low' ? 'Make only slight creative variations.' : variation==='medium' ? 'Make balanced creative variations.' : 'Make highly creative variations.';
        const promptText = `Analyze the uploaded image and create exactly ${numPrompts} unique prompts.\nRules:\n1. Do NOT replicate the image exactly.\n2. Keep the main idea.\n3. ${variationRule}\n4. Prompts suitable for ${platformText}, stock-safe.\n5. Respond strictly in JSON format.\nStyle focus: ${styleText}.`;
        try{
          const data = await callGemini({b64, prompt:promptText, mime:file.type});
          const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
          const prompts = parsePrompts(raw);
          yield {file, prompts};
        }catch(error){
          yield {file, error:error.message||String(error)}
        }
      }
    }

    // ===== UI wiring =====
    function renderThumbs(files){
      const box=$('#thumbs'); box.innerHTML='';
      for(const f of files){ const img=el('img',{className:'thumb'}); img.src=URL.createObjectURL(f); img.title=f.name; box.appendChild(img) }
    }
    function renderItem({file, prompts, error}){
      const item=el('div',{className:'item'});
      const meta=el('div',{className:'meta'});
      meta.innerHTML = `<span>${file.name}</span><span>${(file.size/1024|0)} KB</span>`;
      item.appendChild(meta);
      if(error){
        const p=el('div',{className:'mono'}); p.style.color='var(--err)'; p.textContent=`Error: ${error}`; item.appendChild(p); return item;
      }
      for(const text of prompts){
        const row=el('div');
        const pre=el('pre',{className:'mono',textContent:text}); pre.style.margin=0; pre.style.whiteSpace='pre-wrap';
        const btn=el('button',{textContent:'Copy'}); btn.onclick=()=>{navigator.clipboard.writeText(text); showToast('Copied')}
        row.append(pre,btn); item.appendChild(row)
      }
      return item;
    }

    function setOverallProgress(done,total){ $('#overallBar').style.width = total? ((done/total)*100).toFixed(1)+'%' : '0%' }

    function withAbortable(fn){
      if(aborter){aborter.abort(); aborter=null}
      aborter = new AbortController();
      return {run:fn, signal:aborter.signal}
    }

    // ===== App init =====
    (function(){
      // Keys modal (super simple prompt)
      $('#btnKeys').onclick=()=>{
        const current = loadKeys().join('\n');
        const next = prompt('Gemini API Keys (one per line):', current);
        if(next!==null){ saveKeys(next.trim()); showToast('API keys saved') }
      }

      // Logout
      $('#btnLogout').onclick=()=>{ localStorage.removeItem('auth_token'); location.href='login.html' }

      // Dropzone
      const drop=$('#drop'), file=$('#file'), pick=$('#btnPick');
      pick.onclick=()=>file.click();
      drop.addEventListener('click',()=>file.click());
      drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag')});
      drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
      drop.addEventListener('drop',e=>{e.preventDefault(); drop.classList.remove('drag'); file.files=e.dataTransfer.files; renderThumbs(file.files)});
      file.addEventListener('change',()=>renderThumbs(file.files));
      // Paste support
      document.addEventListener('paste', (e)=>{
        const items = [...(e.clipboardData?.items||[])].filter(i=>i.kind==='file');
        if(!items.length) return;
        const files = items.map(i=>i.getAsFile()).filter(Boolean);
        const dt=new DataTransfer(); files.forEach(f=>dt.items.add(f));
        file.files=dt.files; renderThumbs(file.files); showToast('Image pasted')
      });

      // Buttons
      $('#btnRun').onclick=async()=>{
        const files=[...$('#file').files];
        if(!files.length) return showToast('Pick images first');
        const params={
          numPrompts: parseInt($('#numPrompts').value||'2',10),
          styleFocus: $('#styleFocus').value,
          platform: $('#platform').value,
          variation: $('#variation').value
        };
        const runner = withAbortable(async()=>{
          $('#result').innerHTML=''; $('#status').textContent='Processing…'; setOverallProgress(0,files.length);
          const all=[]; let done=0;
          // Simple concurrency window
          let q=files.slice();
          async function worker(){
            while(q.length){
              const f=q.shift();
              for await (const out of processFiles([f],params)){
                $('#result').appendChild(renderItem(out)); done++; setOverallProgress(done,files.length)
              }
              if(aborter?.signal?.aborted) break;
            }
          }
          await Promise.all(Array.from({length:Math.min(CONCURRENCY, files.length)}, worker));
          $('#status').textContent = aborter?.signal?.aborted ? 'Canceled' : 'Done';
        });
        runner.run();
      };
      $('#btnCancel').onclick=()=>{ if(aborter){aborter.abort(); showToast('Canceled')} };

      // Export
      $('#btnCopyAll').onclick=()=>{
        const all=[...document.querySelectorAll('#result pre')].map(p=>p.textContent).join('\n');
        navigator.clipboard.writeText(all||''); showToast('All copied')
      };
      $('#btnSaveTxt').onclick=()=>{
        const all=[...document.querySelectorAll('#result pre')].map(p=>p.textContent).join('\n\n');
        download('prompts.txt', all||'')
      };
      $('#btnSaveJson').onclick=()=>{
        const groups=[...document.querySelectorAll('.item')].map(card=>{
          const name=(card.querySelector('.meta span')||{}).textContent||'';
          const arr=[...card.querySelectorAll('pre')].map(p=>p.textContent);
          return {[name]:arr}
        });
        download('prompts.json', JSON.stringify(groups,null,2))
      };

      // Boot
      checkAuth();
    })();
  </script>
</body>
</html>
