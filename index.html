<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="manifest" href="manifest.json">
  <title>Image to Prompt Generator Ai</title>
  <style>
    :root {
      --bg1: #e6f0fa;
      --bg2: #ffffff;
      --ink: #333;
      --ink2: #34495e;
      --border: #dfe6e9;
      --brand: #3498db;
      --brandDark: #2980b9;
      --ok: #27ae60;
      --okDark: #219653;
      --muted: #7f8c8d;
      --card: #fff;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background: linear-gradient(to bottom, var(--bg1), var(--bg2));
      color: var(--ink);
      line-height: 1.5;
    }

    .container {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      padding: 18px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.8rem;
      text-align: center;
      color: #2c3e50;
      margin: 0 0 12px;
      line-height: 1.3;
    }

    .subtitle {
      text-align: center;
      color: var(--muted);
      margin: 0 0 20px;
      font-size: 0.92rem;
      padding: 0 8px;
    }

    .settings {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 18px;
    }

    @media (min-width: 768px) {
      .settings {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      }
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
      color: var(--ink2);
      font-size: 0.95rem;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      background: #fff;
      transition: border-color 0.2s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .file-upload {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 16px 0;
    }

    @media (min-width: 600px) {
      .file-upload {
        flex-direction: row;
        align-items: center;
      }
      #imageInput {
        flex: 1;
      }
    }

    button {
      padding: 14px 20px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.1s;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background: var(--brandDark);
    }

    button:active {
      transform: scale(0.98);
    }

    #saveApiKey {
      background: #6c757d;
      margin-top: 8px;
      font-size: 1rem;
      font-weight: normal;
    }

    #saveApiKey:hover {
      background: #5a6268;
    }

    #loading {
      display: none;
      text-align: center;
      color: var(--ok);
      font-size: 1.1rem;
      margin: 16px 0;
      font-weight: 500;
    }

    .spinner {
      border: 3px solid rgba(0,0,0,0.1);
      border-top: 3px solid var(--brand);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #previewContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      max-height: 280px;
      overflow-y: auto;
      margin: 16px 0;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fafafa;
    }

    .preview {
      max-width: 100%;
      height: auto;
      max-height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .hint {
      font-size: 0.85rem;
      color: var(--muted);
      margin: 6px 0 0;
    }

    #result {
      background: #f9f9f9;
      border: 1px solid var(--border);
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
      max-height: 500px;
      overflow-y: auto;
    }

    h3.section {
      margin: 18px 0 10px;
      font-size: 1.25rem;
      color: var(--ink2);
    }

    .prompt-item {
      margin-bottom: 14px;
      background: white;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 600px) {
      .prompt-item {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .prompt-text {
      flex: 1;
      white-space: pre-wrap;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .small {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .prompt-item .copy-btn {
      background: var(--ok);
      padding: 10px 16px;
      border-radius: 8px;
      min-width: 80px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .prompt-item .copy-btn:hover {
      background: var(--okDark);
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 20px;
    }

    @media (min-width: 600px) {
      .action-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }

    #status {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      margin-top: 12px;
      font-size: 0.95rem;
      min-height: 1.5em;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: white;
      color: #555;
      font-size: 0.8rem;
    }

    .muted-box {
      background: white;
      border: 1px dashed var(--border);
      padding: 12px;
      border-radius: 10px;
      color: #666;
      font-size: 0.9rem;
      margin: 16px 0;
    }

    /* Auth section */
    #content {
      display: none;
      text-align: center;
      padding: 20px;
    }

    #logout {
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div id="content">
    <h1>Welcome Boss ðŸ‘‘</h1>
    <p>Kamu berhasil login.</p>
    <button id="logout">Logout</button>
  </div>

  <script>
    const API_VALIDATE = "/.netlify/functions/validate";

    async function checkAuth() {
      const token = localStorage.getItem("auth_token");
      if (!token) {
        location.href = "login.html";
        return;
      }
      try {
        const res = await fetch(API_VALIDATE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token })
        });
        const j = await res.json();
        if (res.ok && j.ok) {
          document.getElementById("content").style.display = "block";
        } else {
          localStorage.removeItem("auth_token");
          location.href = "login.html";
        }
      } catch (err) {
        localStorage.removeItem("auth_token");
        location.href = "login.html";
      }
    }

    document.getElementById("logout").addEventListener("click", () => {
      localStorage.removeItem("auth_token");
      location.href = "login.html";
    });

    checkAuth();
  </script>
 <div class="container">
    <h1>Batch Image Prompt Generator</h1>

    <div class="settings">
      <div>
        <label for="numPrompts">Prompts per Image:</label>
        <input type="number" id="numPrompts" min="1" max="10" value="2">
      </div>
      <div>
        <label for="styleFocus">Style Focus:</label>
        <select id="styleFocus">
          <option value="auto">Auto (Follow Image)</option>
          <option value="realistic">Realistic</option>
          <option value="abstract">Abstract</option>
          <option value="cartoon">Cartoon</option>
          <option value="minimalist">Minimalist</option>
        </select>
      </div>
      <div>
        <label for="platform">Target Platform:</label>
        <select id="platform">
          <option value="adobe_stock">Adobe Stock</option>
          <option value="shutterstock">Shutterstock</option>
          <option value="general">General</option>
        </select>
      </div>
      <div>
        <label for="variation">Variation Level:</label>
        <select id="variation">
          <option value="low">Low (slight changes)</option>
          <option value="medium" selected>Medium (balanced)</option>
          <option value="high">High (very different)</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label for="apiKeys">Gemini API Keys (one per line):</label>
        <textarea id="apiKeys"></textarea>
        <button id="saveApiKey">Save API Keys</button>
      </div>
    </div>

    <div class="file-upload">
      <input type="file" id="imageInput" accept="image/*" multiple>
      <button onclick="uploadAndGenerate()">Upload & Generate</button>
    </div>

    <div id="loading">Processing... <div class="spinner"></div></div>
    <div id="previewContainer"></div>
    <div id="result"></div>
    <div id="status"></div>
    <div class="action-buttons">
      <button id="copyAllBtn" style="display:none;">Copy All Prompts</button>
      <button id="downloadBtn" style="display:none;">Download Prompts as TXT</button>
    </div>
  </div>

  <script>
const cloudName = 'dwgfox722';
const uploadPreset = 'free_upload';
const imgbbKey = '6fc0fd628ee4e20d8ada76d6e155e26d';
const GEMINI_MODEL = "gemini-2.5-flash";
const maxFileSize = 10 * 1024 * 1024; // 10MB
const concurrencyLimit = 3; // Max 3 files at once

// Input Validation
async function validateInput(file, apiKeys) {
  if (!file.type.startsWith('image/')) throw new Error('File must be an image');
  if (file.size > maxFileSize) throw new Error('File size exceeds 10MB');
  if (!apiKeys?.length) throw new Error('No API keys provided');
  return true;
}

async function uploadImgBB(file) {
  const formData = new FormData();
  formData.append('image', file);
  formData.append('expiration', 3600);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${encodeURIComponent(imgbbKey)}`, { method: 'POST', body: formData });
  if (!res.ok) throw new Error("ImgBB upload failed");
  return (await res.json()).data.url;
}

async function uploadCloudinary(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, { method: 'POST', body: formData });
  if (!res.ok) throw new Error("Cloudinary upload failed");
  return (await res.json()).secure_url;
}

async function uploadWithFallback(file) {
  const timeout = (prom, time) => Promise.race([prom, new Promise((_, rej) => setTimeout(() => rej('Timeout'), time))]);
  try {
    return await timeout(uploadImgBB(file), 10000);
  } catch (e) {
    console.warn('ImgBB upload failed:', e);
    try {
      return await timeout(uploadCloudinary(file), 10000);
    } catch (e) {
      console.warn('Cloudinary upload failed:', e);
      return `data:${file.type};base64,${await fileToBase64(file)}`;
    }
  }
}

async function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
  });
}

function normalizePrompts(rawText) {
  rawText = rawText.replace(/```json|```/g, '').trim();
  let prompts;
  try {
    prompts = JSON.parse(rawText);
    if (!Array.isArray(prompts)) throw new Error('Parsed data is not an array');
    prompts = prompts.filter(p => typeof p === 'string' && p.trim());
  } catch {
    prompts = rawText.split('\n').map(l => l.trim()).filter(Boolean);
  }
  return prompts.length ? prompts : ['No valid prompts generated'];
}

async function callGeminiWithRetry(base64Image, promptText, apiKeys) {
  let currentApiIndex = 0;
  const maxRetries = 3;
  while (currentApiIndex < apiKeys.length) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKeys[currentApiIndex]}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              contents: [{ parts: [
                { text: promptText },
                { inlineData: { mimeType: 'image/jpeg', data: base64Image } }
              ] }]
            })
          }
        );
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        return await res.json();
      } catch (e) {
        console.warn(`Attempt ${attempt} with key ${currentApiIndex + 1} failed:`, e);
        if (attempt === maxRetries) currentApiIndex++;
        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
      }
    }
  }
  throw new Error('All API keys exhausted');
}

async function uploadAndGenerate() {
  const files = document.getElementById('imageInput').files;
  if (!files.length) return alert('Select at least one image.');

  const numPrompts = parseInt(document.getElementById('numPrompts').value);
  const styleFocus = document.getElementById('styleFocus').value;
  const platform = document.getElementById('platform').value;
  const variation = document.getElementById('variation').value;
  const apiKeysInput = document.getElementById('apiKeys').value.trim().split('\n').filter(Boolean);

  const loading = document.getElementById('loading');
  const status = document.getElementById('status');
  const previewContainer = document.getElementById('previewContainer');
  const resultDiv = document.getElementById('result');
  const progressBar = document.createElement('div');
  progressBar.style.width = '0%';
  progressBar.style.height = '10px';
  progressBar.style.background = 'blue';
  status.appendChild(progressBar);
  loading.style.display = 'block';
  previewContainer.innerHTML = '';
  resultDiv.innerHTML = '';
  document.getElementById('copyAllBtn').style.display = 'none';
  document.getElementById('downloadBtn').style.display = 'none';
  status.innerText = '';

  const allPrompts = {};
  document.getElementById('copyAllBtn').onclick = () => {
    const allText = Object.values(allPrompts).flat().join('\n');
    navigator.clipboard.writeText(allText || 'No prompts generated.');
  };
  document.getElementById('downloadBtn').onclick = () => {
    const allText = Object.values(allPrompts).flat().join('\n\n');
    const blob = new Blob([allText || 'No prompts generated.'], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'prompts.txt'; a.click();
    URL.revokeObjectURL(url);
  };

  try {
    await validateInput(files[0], apiKeysInput);
    Array.from(files).forEach(file => {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      img.className = 'preview';
      img.title = file.name;
      previewContainer.appendChild(img);
    });

    const fileChunks = [];
    for (let i = 0; i < files.length; i += concurrencyLimit) {
      fileChunks.push(Array.from(files).slice(i, i + concurrencyLimit));
    }

    let processed = 0;
    for (const chunk of fileChunks) {
      const promises = chunk.map(async file => {
        status.innerText = `Processing ${file.name}...`;
        const imageUrl = await uploadWithFallback(file);
        status.innerText = `Uploaded ${file.name}`;
        const base64Image = await fileToBase64(file);
        const styleText = styleFocus === 'auto' ? 'based on the image style' : `in ${styleFocus} style`;
        const platformText = platform === 'general' ? 'general use' : `optimized for ${platform}`;
        const variationRule = variation === 'low' ? 'Make only slight creative variations.' :
                             variation === 'medium' ? 'Make balanced creative variations.' :
                             'Make highly creative variations.';
        const promptText = `
Analyze the uploaded image and create exactly ${numPrompts} unique prompts.
Rules:
1. Do NOT replicate the image exactly.
2. Keep the main idea.
3. ${variationRule}
4. Prompts suitable for ${platformText}, stock-safe.
5. Respond strictly in JSON format.
Style focus: ${styleText}.
        `;
        const apiData = await callGeminiWithRetry(base64Image, promptText, apiKeysInput);
        const rawText = apiData?.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const prompts = normalizePrompts(rawText);
        allPrompts[file.name] = prompts;

        const header = document.createElement('h3');
        header.innerText = `Prompts for ${file.name}`;
        resultDiv.appendChild(header);
        prompts.forEach(text => {
          const div = document.createElement('div');
          div.className = 'prompt-item';
          div.innerText = text;
          const btn = document.createElement('button');
          btn.innerText = 'Copy';
          btn.onclick = () => {
            navigator.clipboard.writeText(text);
            btn.innerText = 'Copied!';
            setTimeout(() => btn.innerText = 'Copy', 2000);
          };
          div.appendChild(btn);
          resultDiv.appendChild(div);
        });
        processed++;
        progressBar.style.width = `${(processed / files.length) * 100}%`;
      });
      await Promise.allSettled(promises);
    }
    status.innerText = 'Processing complete!';
  } catch (err) {
    console.error("Fatal error:", err);
    alert('Error: ' + err.message);
    status.innerText = 'Error during processing.';
  } finally {
    loading.style.display = 'none';
    document.getElementById('copyAllBtn').style.display = 'block';
    document.getElementById('downloadBtn').style.display = 'block';
  }
}

window.onload = () => {
  if (localStorage.getItem('apiKeys')) document.getElementById('apiKeys').value = localStorage.getItem('apiKeys');
};
document.getElementById('saveApiKey').onclick = () => {
  localStorage.setItem('apiKeys', document.getElementById('apiKeys').value.trim());
  alert('API keys saved!');
};
</script>
  
</body>
</html>