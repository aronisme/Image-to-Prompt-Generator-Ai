<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link rel="manifest" href="manifest.json">
  <title>PromptLab â€” Image âžœ Prompt (Lite v2.1)</title>
  <meta name="theme-color" content="#0ea5e9">
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--ink:#e5e7eb;--ink2:#cbd5e1;--muted:#94a3b8;--line:#1f2a44;
      --brand:#0ea5e9;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444
    }
    @media (prefers-color-scheme: light){:root{--bg:#f6f8fb;--card:#fff;--ink:#1f2937;--ink2:#374151;--muted:#6b7280;--line:#e5e7eb}}
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 80% -10%,rgba(14,165,233,.15),transparent),var(--bg);color:var(--ink)}
    .wrap{max-width:1150px;margin:0 auto;padding:20px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .title{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--ok));box-shadow:0 6px 24px rgba(14,165,233,.25)}
    h1{font-size:18px;margin:0}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}

    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid{grid-template-columns:380px 1fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{font-size:14px;margin:0 0 8px;color:var(--ink2)}

    label{display:block;margin:10px 0 6px;color:var(--ink2);font-weight:600;font-size:13px}
    input,select,textarea,button{width:100%;border:1px solid var(--line);background:#0000;color:var(--ink);border-radius:10px;padding:10px 12px;font-size:14px}
    input:focus,select:focus,textarea:focus,button:focus{outline:none;box-shadow:0 0 0 3px rgba(14,165,233,.25)}
    textarea{min-height:90px;resize:vertical}
    button{cursor:pointer;background:var(--brand);border-color:transparent;font-weight:700}
    button.secondary{background:#0000;border-color:var(--line)}
    button.ghost{background:#0000;border-color:transparent;color:var(--muted)}
    button.danger{background:var(--err)}

    .row{display:flex;gap:10px}
    .row > *{flex:1}

    .drop{display:grid;place-items:center;border:2px dashed var(--line);border-radius:14px;padding:18px;text-align:center;color:var(--muted)}
    .drop.drag{border-color:var(--brand)}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;max-height:170px;overflow:auto}
    .thumb{width:110px;height:80px;object-fit:cover;border:1px solid var(--line);border-radius:8px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .result{display:grid;gap:10px;max-height:520px;overflow:auto}
    .item{display:grid;gap:8px;border:1px solid var(--line);background:linear-gradient(0deg,rgba(255,255,255,.02),transparent);border-radius:12px;padding:10px}
    .item .meta{display:flex;justify-content:space-between;gap:8px;color:var(--muted);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .chip.ok{border-color:rgba(34,197,94,.35);color:#86efac}
    .chip.err{border-color:rgba(239,68,68,.35);color:#fca5a5}
    .spin{width:14px;height:14px;border:2px solid rgba(255,255,255,.2);border-top-color:rgba(255,255,255,.9);border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .progress{height:10px;background:#0000;border:1px solid var(--line);border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--ok))}

    .toast{position:fixed;right:14px;bottom:14px;display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:var(--card);border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.25);color:var(--ink);opacity:0;transform:translateY(10px);transition:all .2s}
    .toast.show{opacity:1;transform:translateY(0)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;padding:16px}
    .modal.show{display:grid}
    .sheet{width:min(720px,95vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 30px 80px rgba(0,0,0,.35)}
    .sheet h3{margin:0 0 6px;font-size:16px}

    .muted{color:var(--muted)}
    footer{margin:16px 0;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title"><div class="logo" aria-hidden="true"></div><h1>PromptLab</h1><span class="pill">Lite v3.1</span></div>
      <div class="toolbar">
        <button id="btnKeys" class="secondary" title="Manage API Keys">API Keys</button>
        <button id="btnLogout" class="ghost" title="Logout">Logout</button>
      </div>
    </header>

    <div id="authGate" class="card" hidden>
      <h2>Checking accessâ€¦</h2>
      <div class="progress" aria-label="Auth progress"><div class="bar" id="authBar"></div></div>
      <p class="muted" id="authMsg">Connecting to serverâ€¦</p>
    </div>

    <section class="grid" id="app" hidden>
      <div class="card">
        <h2>Settings</h2>
        <div class="row">
          <div>
            <label for="numPrompts">Prompts per Image</label>
            <input id="numPrompts" type="number" min="1" max="10" value="2" />
          </div>
          <div>
            <label for="variation">Variation Level</label>
            <select id="variation">
              <option value="low">Low (slight)</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="styleFocus">Style Focus</label>
            <select id="styleFocus">
              <option value="auto">Auto (follow image)</option>
              <option value="realistic">Realistic</option>
              <option value="abstract">Abstract</option>
              <option value="cartoon">Cartoon</option>
              <option value="minimalist">Minimalist</option>
            </select>
          </div>
          <div>
            <label for="platform">Target Platform</label>
            <select id="platform">
              <option value="adobe_stock">Adobe Stock</option>
              <option value="shutterstock">Shutterstock</option>
              <option value="general">General</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="animMode">Animation Mode</label>
            <select id="animMode">
              <option value="minimal" selected>Minimal</option>
              <option value="interactive">Interactive</option>
            </select>
          </div>
          <div>
            <label for="concurrency">Concurrency</label>
            <input id="concurrency" type="number" min="1" max="6" value="3" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="delay">Delay (ms)</label>
            <input id="delay" type="number" min="0" max="3000" value="1000" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="btnClear" class="secondary">Clear Selection</button>
          </div>
        </div>

        <label for="file">Images</label>
        <div id="drop" class="drop" tabindex="0" aria-label="Drop zone">
          <div>
            <p class="muted">Drag & drop / click to select / paste (Ctrl+V)</p>
            <input id="file" type="file" accept="image/*" multiple hidden />
            <button id="btnPick" class="secondary">Choose Images</button>
          </div>
        </div>
        <div id="thumbs" class="thumbs" aria-live="polite"></div>

        <div class="row" style="margin-top:10px">
          <button id="btnRun">Generate</button>
          <button id="btnCancel" class="danger">Cancel</button>
        </div>

        <div style="margin-top:10px">
          <div class="progress" aria-label="Overall progress"><div class="bar" id="overallBar"></div></div>
          <p class="muted" id="status">Idle</p>
        </div>
      </div>

      <div class="card">
        <h2>Output</h2>
        <div class="toolbar" style="margin-bottom:10px">
          <button id="btnCopyAll" class="secondary">Copy All</button>
          <button id="btnSaveTxt" class="secondary">Save .txt</button>
          <button id="btnSaveJson" class="secondary">Save .json</button>
          <button id="btnReport" class="secondary">Summary</button>
        </div>
        <div id="result" class="result" aria-live="polite"></div>
      </div>
    </section>

    <footer>Â© PromptLab â€” clientâ€‘side only. Keep content stockâ€‘safe. No trademarked logos.
      <span class="muted">Model: geminiâ€‘2.5â€‘flash</span>
    </footer>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"><span id="toastMsg">Ready</span></div>

  <div id="keysModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h3>API Keys</h3>
      <p class="muted">One key per line. Stored locally in your browser.</p>
      <textarea id="keysInput" placeholder="AIza...
AIza..." class="mono" style="height:120px"></textarea>
      <div class="row" style="margin-top:10px">
        <button id="keysSave">Save</button>
        <button id="keysClose" class="secondary">Close</button>
      </div>
    </div>
  </div>

  <div id="reportModal" class="modal" aria-hidden="true">
    <div class="sheet">
      <h3>Run Summary</h3>
      <p id="summaryText" class="muted">-</p>
      <div id="reportTable" class="mono" style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px"></div>
      <div class="row" style="margin-top:10px">
        <button id="btnDownloadJson">Download JSON</button>
        <button id="btnDownloadCsv" class="secondary">Download CSV</button>
        <button id="reportClose" class="secondary">Close</button>
      </div>
    </div>
  </div>

 <script>
  // ===== Constants =====
  const API_VALIDATE = "/.netlify/functions/validate";
  const GEMINI_MODEL = "gemini-2.5-flash";
  const MAX_FILE_SIZE = 10 * 1024 * 1024;
  const MAX_FILES = 10; // ðŸ”¥ batas maksimal gambar

  // ===== State =====
  let aborter = null;
  let selectedFiles = [];
  let thumbUrls = [];
  let runLog = [];

  // ===== Utilities =====
  const $ = s => document.querySelector(s);
  const el = (tag, attrs = {}) => Object.assign(document.createElement(tag), attrs);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const showToast = m => {
    const t = $('#toast');
    $('#toastMsg').textContent = m;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 1800);
  };

  const toBase64 = file => new Promise((res, rej) => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result.split(',')[1]);
    reader.onerror = rej;
    reader.readAsDataURL(file);
  });

  function saveKeys(str) { localStorage.setItem('apiKeys', str); }
  function loadKeys() {
    return (localStorage.getItem('apiKeys') || '')
      .split('\n').map(s => s.trim()).filter(Boolean);
  }

  function normalizeJsonText(txt) {
    return (txt || '').replace(/```json|```/g, '').trim();
  }

  function sanitizePlainText(s) {
    return (s || '').split('\n').map(l => l.trim()).filter(Boolean);
  }

  function parsePrompts(rawText) {
    try {
      const j = JSON.parse(normalizeJsonText(rawText));
      if (Array.isArray(j)) return j.filter(x => typeof x === 'string' && x.trim());
      if (j && Array.isArray(j.prompts))
        return j.prompts.map(it => typeof it === 'string' ? it : it?.prompt || '').filter(Boolean);
      return sanitizePlainText(rawText);
    } catch {
      return sanitizePlainText(rawText);
    }
  }

  function download(name, text) {
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = el('a', { href: url, download: name });
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(url);
    a.remove();
  }

  function toCsv(rows) {
    const esc = v => ('' + (v ?? '')).replaceAll('"', '""');
    return rows.map(r => Object.values(r).map(v => `"${esc(v)}"`).join(',')).join('\n');
  }



  // ===== Auth Gate =====
  async function checkAuth() {
    const gate = $('#authGate'), bar = $('#authBar'), msg = $('#authMsg');
    gate.hidden = false;
    bar.style.width = '20%';
    msg.textContent = 'Checking tokenâ€¦';
    const token = localStorage.getItem('auth_token');
    if (!token) {
      gate.hidden = true;
      $('#app').hidden = false;
      return;
    }
    try {
      bar.style.width = '60%';
      const res = await fetch(API_VALIDATE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      });
      const j = await res.json().catch(() => ({}));
      bar.style.width = '100%';
      if (res.ok && j.ok) showToast('Access granted');
    } catch (e) {
      console.warn('Auth check failed:', e);
    } finally {
      gate.hidden = true;
      $('#app').hidden = false;
    }
  }

  // ===== Gemini API =====
  async function callGemini({ b64, prompt, mime }) {
    const keys = loadKeys();
    if (!keys.length) throw new Error('No API keys found. Please add one.');

    let keyIdx = 0;
    const MAX_RETRY = 3;

    while (keyIdx < keys.length) {
      const key = keys[keyIdx];
      for (let attempt = 1; attempt <= MAX_RETRY; attempt++) {
        try {
          const res = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              signal: aborter?.signal,
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: mime, data: b64 } }] }]
              })
            }
          );

          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0, 200)}`);
          }

          const json = await res.json();
          const text =
            json?.candidates?.[0]?.content?.parts?.[0]?.text ||
            json?.candidates?.[0]?.output_text ||
            json?.text ||
            JSON.stringify(json);
          return { ok: true, text, raw: json };
        } catch (err) {
          console.warn(`[Gemini] Attempt ${attempt} failed (key ${keyIdx + 1}/${keys.length}):`, err.message);
          if (aborter?.signal?.aborted) return { ok: false, error: 'Aborted' };
          if (attempt === MAX_RETRY) keyIdx++;
          await sleep(400 * attempt);
        }
      }
    }

    return { ok: false, error: 'All keys exhausted or invalid.' };
  }

  // ===== Rendering =====
  function clearThumbs() {
    thumbUrls.forEach(u => URL.revokeObjectURL(u));
    thumbUrls = [];
    $('#thumbs').innerHTML = '';
  }

  function renderThumbs() {
    clearThumbs();
    const box = $('#thumbs');
    for (const f of selectedFiles) {
      const url = URL.createObjectURL(f);
      thumbUrls.push(url);
      const img = el('img', { className: 'thumb', src: url, title: f.name });
      box.appendChild(img);
    }
    // ðŸ”¹ tampilkan counter
    $('#fileCount')?.remove();
    const counter = el('div', { id: 'fileCount', className: 'muted', textContent: `${selectedFiles.length}/${MAX_FILES} selected` });
    box.appendChild(counter);
  }

  function makeItemRow(file) {
    const item = el('div', { className: 'item' });
    const meta = el('div', { className: 'meta' });
    const left = el('div');
    left.innerHTML = `<strong>${file.name}</strong> â€¢ ${(file.size / 1024 | 0)} KB`;
    const chip = el('span', { className: 'chip', innerHTML: `<span class="spin"></span><span>Queued</span>` });
    meta.append(left, chip);
    const pre = el('pre', { className: 'mono', style: 'white-space:pre-wrap' });
    item.append(meta, pre);
    return { item, chip, pre };
  }

  function setChip(chip, type, text) {
    chip.className = `chip ${type}`;
    chip.innerHTML =
      type === 'pending' ? `<span class="spin"></span><span>${text}</span>` :
      `<span>${text}</span>`;
  }

  function setProgress(done, total) {
    $('#overallBar').style.width = `${(done / total) * 100}%`;
  }

  // ===== Worker =====
  async function* processFiles(files, { numPrompts, styleFocus, platform, variation }) {
    for (const file of files) {
      if (!file.type.startsWith('image/')) {
        yield { file, error: 'Not an image file' };
        continue;
      }
      if (file.size > MAX_FILE_SIZE) {
        yield { file, error: 'File exceeds 10MB' };
        continue;
      }

      const b64 = await toBase64(file);
      const styleText = styleFocus === 'auto' ? 'based on the image style' : `in ${styleFocus} style`;
      const platformText = platform === 'general' ? 'general use' : `optimized for ${platform}`;
      const variationRule =
        variation === 'low' ? 'Slight variations only.' :
        variation === 'medium' ? 'Balanced creative variations.' :
        'Highly creative variations.';

      const promptText = `
Analyze this image and create exactly ${numPrompts} unique prompts.
1. Do NOT replicate the image exactly.
2. Keep the main idea.
3. ${variationRule}
4. Stock-safe, ${platformText}.
5. Respond strictly in JSON array.
Style: ${styleText}.
`;

      const start = performance.now();
      const resp = await callGemini({ b64, prompt: promptText, mime: file.type });
      const ms = (performance.now() - start) | 0;

      if (!resp.ok) {
        yield { file, error: resp.error, time: ms };
      } else {
        const prompts = parsePrompts(resp.text);
        yield { file, prompts, time: ms };
      }
    }
  }

  // ===== Init =====
  (function initApp() {
    // --- Modal API keys ---
    const keysModal = $('#keysModal');
    $('#btnKeys').onclick = () => {
      $('#keysInput').value = loadKeys().join('\n');
      keysModal.classList.add('show');
    };
    $('#keysClose').onclick = () => keysModal.classList.remove('show');
    $('#keysSave').onclick = () => {
      saveKeys($('#keysInput').value.trim());
      showToast('API keys saved');
      keysModal.classList.remove('show');
    };

    // --- Files ---
    const fileInput = $('#file');
    $('#btnPick').onclick = () => fileInput.click();

    fileInput.onchange = e => {
      const files = Array.from(e.target.files);
      if (files.length > MAX_FILES) {
        showToast(`âš ï¸ Maksimal ${MAX_FILES} gambar!`);
      }
      selectedFiles = files.slice(0, MAX_FILES);
      renderThumbs();
      showToast(`${selectedFiles.length} file(s) selected`);
    };

    $('#btnClear').onclick = () => {
      selectedFiles = [];
      clearThumbs();
      showToast('Cleared');
    };

    // ðŸ”¹ Drag & drop handler
    const dropZone = $('#drop');
    dropZone.addEventListener('dragover', e => {
      e.preventDefault();
      dropZone.classList.add('drag');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag'));
    dropZone.addEventListener('drop', e => {
      e.preventDefault();
      dropZone.classList.remove('drag');
      const files = Array.from(e.dataTransfer.files);
      if (files.length > MAX_FILES) {
        showToast(`âš ï¸ Maksimal ${MAX_FILES} gambar!`);
      }
      selectedFiles = files.slice(0, MAX_FILES);
      renderThumbs();
      showToast(`${selectedFiles.length} dropped`);
    });

    // ðŸ”¹ Paste handler
    document.addEventListener('paste', e => {
      const items = Array.from(e.clipboardData?.items || []).filter(i => i.kind === 'file');
      if (!items.length) return;
      const files = items.map(i => i.getAsFile()).filter(Boolean);
      if (files.length > MAX_FILES) {
        showToast(`âš ï¸ Maksimal ${MAX_FILES} gambar!`);
      }
      selectedFiles = files.slice(0, MAX_FILES);
      renderThumbs();
      showToast('Image pasted');
    });

    // --- Run ---
    $('#btnRun').onclick = async () => {
      if (!selectedFiles.length) return showToast('Pick images first');
      aborter = new AbortController();
      runLog = [];
      $('#result').innerHTML = '';
      $('#status').textContent = 'Processingâ€¦';
      setProgress(0, selectedFiles.length);

      const params = {
        numPrompts: parseInt($('#numPrompts').value || '2', 10),
        styleFocus: $('#styleFocus').value,
        platform: $('#platform').value,
        variation: $('#variation').value,
        concurrency: Math.max(1, Math.min(6, parseInt($('#concurrency').value || '3', 10))),
        delay: Math.max(0, Math.min(3000, parseInt($('#delay').value || '1000', 10)))
      };

      const rows = selectedFiles.map(f => ({ f, ui: makeItemRow(f) }));
      rows.forEach(r => $('#result').append(r.ui.item));

      let done = 0;
      const queue = [...rows];
      async function worker() {
        while (queue.length && !aborter.signal.aborted) {
          const { f, ui } = queue.shift();
          setChip(ui.chip, 'pending', 'Working');
          for await (const out of processFiles([f], params)) {
            const rec = { file: f.name, kb: (f.size / 1024 | 0), time: out.time || '' };
            if (out.error) {
              rec.status = 'fail'; rec.error = out.error;
              setChip(ui.chip, 'err', 'Error');
              ui.pre.textContent = out.error;
            } else {
              rec.status = 'ok';
              const txt = out.prompts.join('\n\n');
              ui.pre.textContent = txt;
              setChip(ui.chip, 'ok', 'Done');
              const btn = el('button', { textContent: 'Copy' });
              btn.onclick = () => {
                navigator.clipboard.writeText(txt);
                showToast('Copied');
              };
              ui.item.append(btn);
            }
            runLog.push(rec);
          }
          done++;
          setProgress(done, selectedFiles.length);
          if (params.delay) await sleep(params.delay);
        }
      }

      await Promise.all(Array.from({ length: params.concurrency }, () => worker()));

      const ok = runLog.filter(r => r.status === 'ok').length;
      const fail = runLog.length - ok;
      $('#status').textContent = aborter.signal.aborted
        ? 'Canceled'
        : `Done â€¢ ${ok} ok / ${fail} failed`;
    };

    $('#btnCancel').onclick = () => {
      if (aborter) {
        aborter.abort();
        showToast('Canceled');
      }
    };

        // --- Export & Copy ---
    $('#btnCopyAll').onclick = () => {
      const all = [...document.querySelectorAll('#result pre')]
        .map(p => p.textContent)
        .join('\n\n');
      if (!all.trim()) return showToast('No output to copy');
      navigator.clipboard.writeText(all);
      showToast('All copied');
    };

    $('#btnSaveTxt').onclick = () => {
      const all = [...document.querySelectorAll('#result pre')]
        .map(p => p.textContent)
        .join('\n\n');
      if (!all.trim()) return showToast('No output to save');
      download('prompts.txt', all);
      showToast('Saved as TXT');
    };

    $('#btnSaveJson').onclick = () => {
      const groups = [...document.querySelectorAll('.item')].map(card => {
        const name = (card.querySelector('.meta strong') || {}).textContent || '';
        const content = [...card.querySelectorAll('pre')].map(p => p.textContent);
        return { file: name, prompts: content };
      });
      if (!groups.length) return showToast('No data to save');
      download('prompts.json', JSON.stringify(groups, null, 2));
      showToast('Saved as JSON');
    };

    // --- Report Modal ---
    $('#btnReport').onclick = () => {
      const total = runLog.length;
      const success = runLog.filter(r => r.status === 'ok').length;
      const failed = total - success;
      $('#summaryText').textContent = `Total: ${total} â€¢ Success: ${success} â€¢ Failed: ${failed}`;

      const box = $('#reportTable');
      box.innerHTML = '';
      const header = el('div', {
        innerHTML: 'file,size_kb,status,time_ms,error',
        className: 'mono',
        style: 'opacity:.7;margin-bottom:6px'
      });
      box.appendChild(header);

      for (const r of runLog) {
        const row = el('div', {
          style: 'display:grid;grid-template-columns:2fr 80px 80px 80px 1fr;gap:6px;padding:4px 0;border-bottom:1px dashed var(--line)'
        });
        row.innerHTML = `
          <div>${r.file}</div>
          <div>${r.kb}</div>
          <div>${r.status}</div>
          <div>${r.time || ''}</div>
          <div class="muted">${r.error || ''}</div>
        `;
        box.appendChild(row);
      }

      $('#reportModal').classList.add('show');
    };

    $('#reportClose').onclick = () => $('#reportModal').classList.remove('show');
    $('#btnDownloadJson').onclick = () => download('report.json', JSON.stringify(runLog, null, 2));
    $('#btnDownloadCsv').onclick = () => download('report.csv', toCsv(runLog));


    checkAuth();
  })();
</script>


</body>
</html>